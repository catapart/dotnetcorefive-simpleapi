<html>
<body>
    
    <div class="card">
        <header>
            <h2>Messaging</h2>
            <div>
                <h4>Participants</h4>
                <ul id="messaging-participants"></ul>
            </div>
            <input id="chat-session-key" type="text" placeholder="Session Key" />
            <div>
                <span class="title">Display Name:</span>
                <input id="chat-display-name" type="text" />
            </div>
            <button id="join-chat" type="button">Join Chat</button>
        </header>
        <ul id="message-history"></ul>
        <div>
            <textarea id="message"></textarea>
            <button id="send-message" type="button">Send</button>
        </div>
    </div>
    <div class="card">
        <video width="1280" height="720" id="client-webcam"></video>
        <ul class="remote-webcams"></ul>
        <div>
            <button id="get-webcam-feed" type="button">Get Webcam Feed</button>
            <button id="start-video-chat" type="button">Start Stream</button>
            <button id="end-video-chat" type="button">End Stream</button>
        </div>
    </div>
    <script>
        var apiDomain = '192.168.254.12';
        var chatSocket = null;
        var hostSessionToken = null;
        var participantId = null;
        var chatParticipants = {};

        var videoChatSocket = null;
        var localStream = null;
        var remoteStreams = [];

        document.addEventListener('DOMContentLoaded', async () => {



            async function joinChat_onClick(event) {
                if (chatSocket != null) {
                    console.error('Session is already active.');
                    return;
                }

                try {
                    let sessionKey = $chatSessionKey.value;
                    console.log(sessionKey);

                    chatSocket = new WebSocket(`wss://${apiDomain}:5001/video/${sessionKey}`);

                    chatSocket.onopen = function (e) {
                        console.log("[open] Connection established");
                    };

                    chatSocket.onmessage = function (event) {
                        console.log(`[message] Data received from server: ${event.data}`);
                        let data = JSON.parse(event.data);

                        if (data.MessageType == 1) {
                            let value = JSON.parse(data.Message);
                            console.log(value);
                            initChat(value);
                        }
                        else if (data.MessageType == 3) {
                            let value = JSON.parse(data.Message);
                            console.log(value);
                            updateParticipant(value);
                            updateParticipants();
                        }
                        else if (data.MessageType == 5) {
                            let value = JSON.parse(data.Message);
                            console.log(value);
                            addChatUpdate(value.status, value.peer);
                        }
                        else if (data.MessageType == 8) {
                            addChatMessage(data);
                        }
                        console.log(data);
                    };

                    chatSocket.onclose = function (event) {
                        if (event.wasClean) {
                            console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                        } else {
                            // e.g. server process killed or network down
                            // event.code is usually 1006 in this case
                            console.log('[close] Connection died');
                        }
                        chatSocket = null;
                    };

                    chatSocket.onerror = function (error) {
                        console.log(`[error] ${error.message}`);
                    };

                    window.addEventListener('beforeunload', () => {
                        chatSocket.onclose = function () { }; // disable onclose handler first
                        chatSocket.close();
                    }, { once: true });

                } catch (ex) { console.error(ex); }
            }

            async function sendMessage_onClick(event) {
                if (chatSocket == null) {
                    console.error("No session has been started.");
                    return;
                }

                console.log("Sending to server");
                addChatMessage({ SenderId: participantId, Message: $message.value });
                chatSocket.send(JSON.stringify({ Message: $message.value }));
            }

            async function getWebcam_onClick(event) {
                console.log('Requesting local stream');
                $getWebcamButton.disabled = true;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                    console.log('Received local stream');
                    $clientWebcam.srcObject = stream;
                    localStream = stream;
                    $getWebcamButton.disabled = false;
                }
                catch (exception) {
                    console.error(`getUserMedia() error: ${exception.name}`);
                }
            }

            async function startVideoChat_onClick(event) {



                $clientWebcam.disabled = true;
                $endVideoChatButton.disabled = false;
                console.log('Starting stream');
                startTime = window.performance.now();
                const videoTracks = localStream.getVideoTracks();
                const audioTracks = localStream.getAudioTracks();
                if (videoTracks.length > 0) {
                    console.log(`Using video device: ${videoTracks[0].label}`);
                }
                if (audioTracks.length > 0) {
                    console.log(`Using audio device: ${audioTracks[0].label}`);
                }


                const configuration = getSelectedSdpSemantics();
                console.log('RTCPeerConnection configuration:', configuration);
                pc1 = new RTCPeerConnection(configuration);
                console.log('Created local peer connection object pc1');
                pc1.addEventListener('icecandidate', e => onIceCandidate(pc1, e));
                pc2 = new RTCPeerConnection(configuration);
                console.log('Created remote peer connection object pc2');
                pc2.addEventListener('icecandidate', e => onIceCandidate(pc2, e));
                pc1.addEventListener('iceconnectionstatechange', e => onIceStateChange(pc1, e));
                pc2.addEventListener('iceconnectionstatechange', e => onIceStateChange(pc2, e));
                pc2.addEventListener('track', gotRemoteStream);

                localStream.getTracks().forEach(track => pc1.addTrack(track, localStream));
                console.log('Added local stream to pc1');

                try {
                    console.log('pc1 createOffer start');
                    const offer = await pc1.createOffer(offerOptions);
                    await onCreateOfferSuccess(offer);
                } catch (e) {
                    onCreateSessionDescriptionError(e);
                }








                let totalBytes = $form['uploadfile'].files[0].size;
                $progressTotal.textContent = totalBytes;

                const response = await fetch(`https://${apiDomain}:5001/api/websocket/progress/${totalBytes}`);
                try {
                    let sessionKey = await response.text();
                    console.log(sessionKey);

                    let socket = new WebSocket(`wss://${apiDomain}:5001/progress/${sessionKey}`);

                    socket.onopen = function (e) {
                        console.log("[open] Connection established");
                        console.log("Sending to server");
                        socket.send("Handshake");
                    };

                    socket.onmessage = function (event) {
                        console.log(`[message] Data received from server: ${event.data}`);
                        let data = JSON.parse(event.data);
                        console.log(data);
                        $progressValue.textContent = data.UnitsCompleted;
                        $progressPercentage.value = (data.UnitsCompleted / data.UnitTotal) * 100;
                    };

                    socket.onclose = function (event) {
                        if (event.wasClean) {
                            console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                        } else {
                            // e.g. server process killed or network down
                            // event.code is usually 1006 in this case
                            console.log('[close] Connection died');
                        }
                    };

                    socket.onerror = function (error) {
                        console.log(`[error] ${error.message}`);
                    };

                    window.addEventListener('beforeunload', () => {
                        socket.onclose = function () { }; // disable onclose handler first
                        socket.close();
                    }, { once: true });

                    let options =
                    {
                        method: "POST",
                        body: new FormData($form)
                    };

                    const response2 = await fetch(`https://${apiDomain}:5001/api/streaming/progress/${sessionKey}`, options);
                    if (!response2.ok) {
                        try {
                            let result1 = await response2.text();
                            console.log(result1)

                        } catch (ex) { console.error(ex); }
                    }
                    else {
                        console.log(await response2.json());
                    }

                } catch (ex) { console.error(ex); }
            }

            async function endVideoChat_onClick(event) {

            }

            function initChat(messageData) {
                participantId = messageData.SessionToken.SocketId;
                // add all participants that are already in the session
                for (let i = 0; i < messageData.Participants.length; i++) {
                    if (messageData.Participants[i].SocketId == messageData.HostId) {
                        hostSessionToken = messageData.Participants[i];
                    }
                    updateParticipant(messageData.Participants[i], messageData.HostId, false);
                }
                updateParticipants(messageData.Participants);

                makeIntroduction(messageData.SessionToken);
            }

            function makeIntroduction(token) {
                token.DisplayName = $chatDisplayName.value;
                token.IconUrl = '';

                console.log("Sending Introduction: ", token);
                let message = JSON.stringify(token);
                chatSocket.send(JSON.stringify({ Type: 2, SenderId: token.SocketId, Message: message }));
            }

            function updateParticipant(token, hostId, reportUpdate = true) {
                let dirtyToken = null;
                if (chatParticipants[token.SocketId] != null) {
                    dirtyToken = Object.assign({ initialized: false }, chatParticipants[token.SocketId]);
                }

                chatParticipants[token.SocketId] = token;

                if (reportUpdate === true) {
                    let displayName = (token.DisplayName == '') ? token.SocketId : token.DisplayName;
                    let $message = document.createElement('li');
                    $message.classList.add('message', 'status');

                    if (dirtyToken != null) {

                        let dirtyTokenDisplayName = (dirtyToken.DisplayName == '') ? dirtyToken.SocketId : dirtyToken.DisplayName;
                        if (dirtyToken.initialized != null) {
                            $message.innerHTML = `<div>${displayName} has joined the chat.</div>`;
                            delete dirtyToken.initialized;
                        }
                        else if (dirtyTokenDisplayName != displayName) {
                            $message.innerHTML = `<div>${displayName} has updated their Display Name <em>[Formerly: ${dirtyTokenDisplayName}].</div>`;
                        }
                    }
                    else {
                        if (hostSessionToken.SocketId == token.SocketId) {
                            $message.innerHTML = `<div>Host ${displayName} has started the chat.</div>`;
                        }
                        else {
                            chatParticipants[hostId] = hostSessionToken;
                            $message.innerHTML = `<div>${displayName} has joined the chat.</div>`;
                        }

                    }

                    $messageHistory.appendChild($message);

                    if (hostSessionToken.SocketId == participantId) {
                        chatSocket.send(JSON.stringify({ Type: 3, SenderId: participantId, Message: JSON.stringify(token) }))
                    }
                }
            }
            function updateParticipants() {
                while ($messagingParticipants.lastChild) {
                    $messagingParticipants.lastChild.remove();
                }

                for (let property in chatParticipants) {

                    let participant = chatParticipants[property];
                    let displayName = (participant.DisplayName == '') ? `[${participant.SocketId}]` : participant.DisplayName;
                    let $participant = document.createElement('li');
                    $participant.classList.add('participant');
                    $participant.textContent = displayName;
                    $messagingParticipants.appendChild($participant);
                }
            }
            function addChatUpdate(status, messageData) {
                let action = (status == 'connect') ? 'joined' : 'left';
                let displayName = (messageData.DisplayName == '') ? `[${messageData.SocketId}]` : messageData.DisplayName;
                let $message = document.createElement('li');
                $message.classList.add('message', 'status');
                $message.innerHTML = `<div>${displayName} has ${action} the chat.</div>`;

                $messageHistory.appendChild($message);

                if (status == 'connect') {
                    chatParticipants[messageData.SocketId] = messageData;
                }
                else if (status == 'disconnect') {
                    let participant = chatParticipants[messageData.SocketId];
                    if (participant != null) {
                        delete chatParticipants[messageData.SocketId];
                    }
                }

                updateParticipants(chatParticipants);
            }
            function addChatMessage(messageData) {
                let participant = chatParticipants[messageData.SenderId];
                if (participant == null) {
                    console.error('Unknown Participant. Socket ID: ' + messageData.SenderId);
                    return;
                }
                let $message = document.createElement('li');
                $message.classList.add('message');
                $message.innerHTML = `<header>
                    <img class="icon" src="${participant.IconUrl || ''}" />
                    <span class="name">${participant.DisplayName || ''}</span>
                </header>
                <div>${messageData.Message}</div>`;

                $messageHistory.appendChild($message);
            }

            async function videoChat_OnRemoteStream(event) {
                if (remoteVideo.srcObject !== event.streams[0]) {
                    //remoteVideo.srcObject = event.streams[0];
                    //console.log('pc2 received remote stream');
                }
            }


            var $clientWebcam = document.getElementById('client-webcam');
            var $remoteWebcams = document.getElementById('remote-webcams');
            var $getWebcamButton = document.getElementById('get-webcam-feed');
            var $startVideoChatButton = document.getElementById('start-video-chat');
            var $endVideoChatButton = document.getElementById('end-video-chat');

            var $chatDisplayName = document.getElementById('chat-display-name');
            var $chatSessionKey = document.getElementById('chat-session-key');
            var $joinChat = document.getElementById('join-chat');
            var $messagingParticipants = document.getElementById('messaging-participants');
            var $messageHistory = document.getElementById('message-history');
            var $message = document.getElementById('message');
            var $sendMessageButton = document.getElementById('send-message');


            $joinChat.addEventListener('click', joinChat_onClick);
            $sendMessageButton.addEventListener('click', sendMessage_onClick);

            $getWebcamButton.addEventListener('click', getWebcam_onClick);
            $startVideoChatButton.addEventListener('click', startVideoChat_onClick);
            $endVideoChatButton.addEventListener('click', endVideoChat_onClick);
        });
    </script>
</body>
</html>